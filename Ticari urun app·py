import streamlit as st
import geopandas as gpd
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import json
from shapely.geometry import LineString, MultiLineString
from datetime import datetime, timedelta
import warnings

warnings.filterwarnings("ignore")

# =============================================================================
# PAGE CONFIG
# =============================================================================
st.set_page_config(page_title="Ticari ÃœrÃ¼n Analizi", layout="wide")
st.title("ðŸ’Š Ticari ÃœrÃ¼n SatÄ±ÅŸ Analizi - TÃ¼rkiye HaritasÄ±")

# =============================================================================
# BÃ–LGE RENKLERÄ°
# =============================================================================
REGION_COLORS = {
    "MARMARA": "#0EA5E9",
    "BATI ANADOLU": "#14B8A6",
    "EGE": "#FCD34D",
    "Ä°Ã‡ ANADOLU": "#F59E0B",
    "GÃœNEY DOÄžU ANADOLU": "#E07A5F",
    "KUZEY ANADOLU": "#059669",
    "KARADENÄ°Z": "#059669",
    "AKDENÄ°Z": "#8B5CF6",
    "DOÄžU ANADOLU": "#7C3AED",
    "DÄ°ÄžER": "#64748B"
}

# Åžehir eÅŸleÅŸtirme
FIX_CITY_MAP = {
    "AGRI": "AÄžRI", "BARTÃ„Â±N": "BARTIN", "BINGÃƒÂ¶L": "BÄ°NGÃ–L",
    "DÃƒÂ¼ZCE": "DÃœZCE", "ELAZIG": "ELAZIÄž", "ESKISEHIR": "ESKÄ°ÅžEHÄ°R",
    "GÃƒÂ¼MÃƒÂ¼SHANE": "GÃœMÃœÅžHANE", "HAKKARI": "HAKKARÄ°",
    "ISTANBUL": "Ä°STANBUL", "IZMIR": "Ä°ZMÄ°R", "IÃ„\x9fDIR": "IÄžDIR",
    "KARABÃƒÂ¼K": "KARABÃœK", "KINKKALE": "KIRIKKALE", "KIRSEHIR": "KIRÅžEHÄ°R",
    "KÃƒÂ¼TAHYA": "KÃœTAHYA", "MUGLA": "MUÄžLA", "MUS": "MUÅž",
    "NEVSEHIR": "NEVÅžEHÄ°R", "NIGDE": "NÄ°ÄžDE", "SANLIURFA": "ÅžANLIURFA",
    "SIRNAK": "ÅžIRNAK", "TEKIRDAG": "TEKÄ°RDAÄž", "USAK": "UÅžAK",
    "ZINGULDAK": "ZONGULDAK", "Ãƒ\x87ANAKKALE": "Ã‡ANAKKALE",
    "Ãƒ\x87ANKIRI": "Ã‡ANKIRI", "Ãƒ\x87ORUM": "Ã‡ORUM", "K. MARAS": "KAHRAMANMARAÅž"
}

def normalize_city(name):
    if pd.isna(name):
        return None
    name = str(name).upper().strip()
    tr_map = {"Ä°": "I", "Äž": "G", "Ãœ": "U", "Åž": "S", "Ã–": "O", "Ã‡": "C", "Ã‚": "A"}
    for k, v in tr_map.items():
        name = name.replace(k, v)
    return name

@st.cache_data
def load_excel():
    df = pd.read_excel('/mnt/user-data/uploads/Ticari_ÃœrÃ¼n_2025.xlsx')
    df['DATE'] = pd.to_datetime(df['DATE'])
    return df

@st.cache_resource
def load_geo():
    gdf = gpd.read_file("/mnt/user-data/uploads/turkey.geojson")
    gdf["raw_name"] = gdf["name"].str.upper()
    gdf["fixed_name"] = gdf["raw_name"].replace(FIX_CITY_MAP)
    gdf["CITY_KEY"] = gdf["fixed_name"].apply(normalize_city)
    return gdf

# =============================================================================
# DATA PREP - ÃœRÃœN SEÃ‡Ä°MÄ°NE GÃ–RE
# =============================================================================
def prepare_product_data(df, gdf, selected_product, start_date, end_date):
    """
    SeÃ§ilen Ã¼rÃ¼n iÃ§in veriyi hazÄ±rla
    Ã–rnek: TROCMETAM seÃ§ilirse:
    - PF_Sales = TROCMETAM kolonu
    - Total_Market = TROCMETAM + DIGER TROCMETAM
    """
    # Tarih filtreleme
    df_filtered = df[(df['DATE'] >= start_date) & (df['DATE'] <= end_date)].copy()
    
    # ÃœrÃ¼n kolonlarÄ±nÄ± belirle
    if selected_product == "TROCMETAM":
        pf_col = "TROCMETAM"
        other_col = "DIGER TROCMETAM"
    elif selected_product == "CORTIPOL":
        pf_col = "CORTIPOL"
        other_col = "DIGER CORTIPOL"
    elif selected_product == "DEKSAMETAZON":
        pf_col = "DEKSAMETAZON"
        other_col = "DIGER DEKSAMETAZON"
    else:  # PF IZOTONIK
        pf_col = "PF IZOTONIK"
        other_col = "DIGER IZOTONIK"
    
    # Åžehir bazÄ±nda toplam
    city_df = df_filtered.groupby(['CITY', 'REGION', 'MANAGER']).agg({
        pf_col: 'sum',
        other_col: 'sum'
    }).reset_index()
    
    city_df.columns = ['Åžehir', 'BÃ¶lge', 'MÃ¼dÃ¼r', 'PF SatÄ±ÅŸ', 'Rakip SatÄ±ÅŸ']
    city_df['Toplam Pazar'] = city_df['PF SatÄ±ÅŸ'] + city_df['Rakip SatÄ±ÅŸ']
    city_df['Pazar PayÄ± %'] = (city_df['PF SatÄ±ÅŸ'] / city_df['Toplam Pazar'] * 100).round(2)
    city_df['Pazar PayÄ± %'] = city_df['Pazar PayÄ± %'].replace([float('inf'), -float('inf')], 0).fillna(0)
    
    # Åžehir eÅŸleÅŸtirme
    city_df["Åžehir_fix"] = city_df["Åžehir"].str.upper().replace(FIX_CITY_MAP)
    city_df["CITY_KEY"] = city_df["Åžehir_fix"].apply(normalize_city)
    city_df["BÃ¶lge"] = city_df["BÃ¶lge"].str.upper()
    city_df["MÃ¼dÃ¼r"] = city_df["MÃ¼dÃ¼r"].str.upper()
    
    # GeoDataFrame ile birleÅŸtir
    merged = gdf.merge(city_df, on="CITY_KEY", how="left")
    merged["Åžehir"] = merged["fixed_name"]
    merged["PF SatÄ±ÅŸ"] = merged["PF SatÄ±ÅŸ"].fillna(0)
    merged["Rakip SatÄ±ÅŸ"] = merged["Rakip SatÄ±ÅŸ"].fillna(0)
    merged["Toplam Pazar"] = merged["Toplam Pazar"].fillna(0)
    merged["BÃ¶lge"] = merged["BÃ¶lge"].fillna("DÄ°ÄžER")
    merged["MÃ¼dÃ¼r"] = merged["MÃ¼dÃ¼r"].fillna("YOK")
    merged["Pazar PayÄ± %"] = merged["Pazar PayÄ± %"].fillna(0)
    
    # BÃ¶lge bazÄ±nda toplam
    bolge_df = merged.groupby("BÃ¶lge", as_index=False).agg({
        "PF SatÄ±ÅŸ": "sum",
        "Toplam Pazar": "sum"
    }).sort_values("PF SatÄ±ÅŸ", ascending=False)
    bolge_df["Pazar PayÄ± %"] = (bolge_df["PF SatÄ±ÅŸ"] / bolge_df["Toplam Pazar"] * 100).round(2)
    bolge_df["Pazar PayÄ± %"] = bolge_df["Pazar PayÄ± %"].replace([float('inf'), -float('inf')], 0).fillna(0)
    
    return merged, bolge_df, city_df

# =============================================================================
# ZAMAN SERÄ°SÄ° ANALÄ°ZÄ°
# =============================================================================
def get_time_series(df, product, region=None, city=None):
    """AylÄ±k trend analizi"""
    if product == "TROCMETAM":
        pf_col, other_col = "TROCMETAM", "DIGER TROCMETAM"
    elif product == "CORTIPOL":
        pf_col, other_col = "CORTIPOL", "DIGER CORTIPOL"
    elif product == "DEKSAMETAZON":
        pf_col, other_col = "DEKSAMETAZON", "DIGER DEKSAMETAZON"
    else:
        pf_col, other_col = "PF IZOTONIK", "DIGER IZOTONIK"
    
    df_filtered = df.copy()
    if region:
        df_filtered = df_filtered[df_filtered['REGION'] == region]
    if city:
        df_filtered = df_filtered[df_filtered['CITY'] == city]
    
    monthly = df_filtered.groupby('DATE').agg({
        pf_col: 'sum',
        other_col: 'sum'
    }).reset_index()
    
    monthly.columns = ['Tarih', 'PF SatÄ±ÅŸ', 'Rakip SatÄ±ÅŸ']
    monthly['Toplam Pazar'] = monthly['PF SatÄ±ÅŸ'] + monthly['Rakip SatÄ±ÅŸ']
    monthly['Pazar PayÄ± %'] = (monthly['PF SatÄ±ÅŸ'] / monthly['Toplam Pazar'] * 100).round(2)
    
    return monthly

def lines_to_lonlat(geom):
    lons, lats = [], []
    if isinstance(geom, LineString):
        xs, ys = geom.xy
        lons += list(xs) + [None]
        lats += list(ys) + [None]
    elif isinstance(geom, MultiLineString):
        for line in geom.geoms:
            xs, ys = line.xy
            lons += list(xs) + [None]
            lats += list(ys) + [None]
    return lons, lats

def get_region_center(gdf_region):
    centroid = gdf_region.geometry.unary_union.centroid
    return centroid.x, centroid.y

# =============================================================================
# HARÄ°TA OLUÅžTURMA
# =============================================================================
def create_figure(gdf, view_mode, filtered_pf_toplam):
    fig = go.Figure()
    
    for region in gdf["BÃ¶lge"].unique():
        region_gdf = gdf[gdf["BÃ¶lge"] == region]
        color = REGION_COLORS.get(region, "#CCCCCC")
        
        fig.add_choropleth(
            geojson=json.loads(region_gdf.to_json()),
            locations=region_gdf.index,
            z=[1] * len(region_gdf),
            colorscale=[[0, color], [1, color]],
            marker_line_color="white",
            marker_line_width=1.5,
            showscale=False,
            customdata=list(zip(
                region_gdf["Åžehir"],
                region_gdf["BÃ¶lge"],
                region_gdf["PF SatÄ±ÅŸ"],
                region_gdf["Pazar PayÄ± %"]
            )),
            hovertemplate="<b>%{customdata[0]}</b><br>BÃ¶lge: %{customdata[1]}<br>PF SatÄ±ÅŸ: %{customdata[2]:,.0f}<br>Pazar PayÄ±: %{customdata[3]:.1f}%<extra></extra>",
            name=region
        )
    
    lons, lats = [], []
    for geom in gdf.geometry.boundary:
        lo, la = lines_to_lonlat(geom)
        lons += lo
        lats += la
    
    fig.add_scattergeo(lon=lons, lat=lats, mode="lines", line=dict(color="rgba(255,255,255,0.8)", width=1), hoverinfo="skip", showlegend=False)
    
    if view_mode == "BÃ¶lge GÃ¶rÃ¼nÃ¼mÃ¼":
        label_lons, label_lats, label_texts = [], [], []
        for region in gdf["BÃ¶lge"].unique():
            region_gdf = gdf[gdf["BÃ¶lge"] == region]
            total = region_gdf["PF SatÄ±ÅŸ"].sum()
            if total > 0:
                percent = (total / filtered_pf_toplam * 100) if filtered_pf_toplam > 0 else 0
                pazar_payi = (total / region_gdf["Toplam Pazar"].sum() * 100) if region_gdf["Toplam Pazar"].sum() > 0 else 0
                lon, lat = get_region_center(region_gdf)
                label_lons.append(lon)
                label_lats.append(lat)
                label_texts.append(f"<b>{region}</b><br>{total:,.0f} ({percent:.1f}%)<br>Pazar PayÄ±: {pazar_payi:.1f}%")
        
        fig.add_scattergeo(lon=label_lons, lat=label_lats, mode="text", text=label_texts, textfont=dict(size=10, color="black", family="Arial Black"), hoverinfo="skip", showlegend=False)
    else:
        city_lons, city_lats, city_texts = [], [], []
        for idx, row in gdf.iterrows():
            if row["PF SatÄ±ÅŸ"] > 0:
                percent = (row["PF SatÄ±ÅŸ"] / filtered_pf_toplam * 100) if filtered_pf_toplam > 0 else 0
                centroid = row.geometry.centroid
                city_lons.append(centroid.x)
                city_lats.append(centroid.y)
                city_texts.append(f"<b>{row['Åžehir']}</b><br>{row['PF SatÄ±ÅŸ']:,.0f} ({percent:.1f}%)<br>Pazar: {row['Pazar PayÄ± %']:.1f}%")
        
        fig.add_scattergeo(lon=city_lons, lat=city_lats, mode="text", text=city_texts, textfont=dict(size=8, color="black", family="Arial"), hoverinfo="skip", showlegend=False)
    
    fig.update_layout(
        geo=dict(projection=dict(type="mercator"), center=dict(lat=39, lon=35), lonaxis=dict(range=[25, 45]), lataxis=dict(range=[35, 43]), visible=False, bgcolor="rgba(240,240,240,0.3)"),
        height=750, margin=dict(l=0, r=0, t=40, b=0), paper_bgcolor="white"
    )
    return fig

# =============================================================================
# APP FLOW
# =============================================================================
st.sidebar.header("ðŸ“Š ÃœrÃ¼n & Tarih SeÃ§imi")

# Veriyi yÃ¼kle
raw_df = load_excel()
geo = load_geo()

# ÃœRÃœN SEÃ‡Ä°MÄ°
selected_product = st.sidebar.selectbox(
    "ðŸ’Š ÃœrÃ¼n SeÃ§in",
    ["TROCMETAM", "CORTIPOL", "DEKSAMETAZON", "PF IZOTONIK"]
)

st.sidebar.markdown("---")

# TARÄ°H FÄ°LTRELEME
st.sidebar.subheader("ðŸ“… Tarih AralÄ±ÄŸÄ±")

min_date = raw_df['DATE'].min()
max_date = raw_df['DATE'].max()

# Tarih seÃ§im modu
date_mode = st.sidebar.radio(
    "Mod SeÃ§in",
    ["Son 3 Ay", "TÃ¼m Veriler", "Ã–zel AralÄ±k"],
    index=0
)

if date_mode == "Son 3 Ay":
    end_date = max_date
    start_date = end_date - pd.DateOffset(months=3)
    st.sidebar.info(f"ðŸ“† {start_date.strftime('%Y-%m')} - {end_date.strftime('%Y-%m')}")
elif date_mode == "TÃ¼m Veriler":
    start_date = min_date
    end_date = max_date
    st.sidebar.info(f"ðŸ“† {start_date.strftime('%Y-%m')} - {end_date.strftime('%Y-%m')}")
else:
    col_d1, col_d2 = st.sidebar.columns(2)
    with col_d1:
        start_date = st.date_input("BaÅŸlangÄ±Ã§", min_date, min_value=min_date, max_value=max_date)
    with col_d2:
        end_date = st.date_input("BitiÅŸ", max_date, min_value=min_date, max_value=max_date)
    start_date = pd.to_datetime(start_date)
    end_date = pd.to_datetime(end_date)

# Veriyi hazÄ±rla
merged, bolge_df, city_df = prepare_product_data(raw_df, geo, selected_product, start_date, end_date)

st.sidebar.markdown("---")
st.sidebar.header("ðŸ” Filtreler")

view_mode = st.sidebar.radio("GÃ¶rÃ¼nÃ¼m", ["BÃ¶lge GÃ¶rÃ¼nÃ¼mÃ¼", "Åžehir GÃ¶rÃ¼nÃ¼mÃ¼"], index=0)

mudur_list = ["TÃœMÃœ"] + sorted(merged["MÃ¼dÃ¼r"].unique())
selected_mudur = st.sidebar.selectbox("MÃ¼dÃ¼r", mudur_list)

bolge_list = ["TÃœMÃœ"] + sorted([b for b in merged["BÃ¶lge"].unique() if b != "DÄ°ÄžER"])
selected_bolge = st.sidebar.selectbox("BÃ¶lge", bolge_list)

# Filtreleme
if selected_mudur != "TÃœMÃœ":
    merged = merged[merged["MÃ¼dÃ¼r"] == selected_mudur]
if selected_bolge != "TÃœMÃœ":
    merged = merged[merged["BÃ¶lge"] == selected_bolge]

filtered_pf = merged["PF SatÄ±ÅŸ"].sum()
filtered_market = merged["Toplam Pazar"].sum()
filtered_cities = (merged["PF SatÄ±ÅŸ"] > 0).sum()

# HARÄ°TA
st.markdown(f"### ðŸ—ºï¸ {selected_product} - TÃ¼rkiye DaÄŸÄ±lÄ±mÄ±")
st.caption(f"ðŸ“† {start_date.strftime('%Y-%m')} - {end_date.strftime('%Y-%m')} ({date_mode})")

fig = create_figure(merged, view_mode, filtered_pf)
st.plotly_chart(fig, use_container_width=True)

# METRÄ°KLER
col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("ðŸ’Š PF SatÄ±ÅŸ", f"{filtered_pf:,.0f}")
with col2:
    st.metric("ðŸª Toplam Pazar", f"{filtered_market:,.0f}")
with col3:
    pazar_payi = (filtered_pf / filtered_market * 100) if filtered_market > 0 else 0
    st.metric("ðŸ“Š Pazar PayÄ±", f"%{pazar_payi:.1f}")
with col4:
    st.metric("ðŸ™ï¸ Aktif Åžehir", f"{filtered_cities}")

st.markdown("---")

# =============================================================================
# ZAMAN SERÄ°SÄ° ANALÄ°ZÄ°
# =============================================================================
st.subheader("ðŸ“ˆ Zaman Serisi Analizi")

col_ts1, col_ts2 = st.columns(2)

with col_ts1:
    st.markdown("#### ðŸ“… AylÄ±k SatÄ±ÅŸ Trendi")
    monthly_ts = get_time_series(raw_df, selected_product, 
                                  region=selected_bolge if selected_bolge != "TÃœMÃœ" else None)
    
    fig_ts = go.Figure()
    fig_ts.add_trace(go.Scatter(
        x=monthly_ts['Tarih'], y=monthly_ts['PF SatÄ±ÅŸ'],
        name='PF SatÄ±ÅŸ', mode='lines+markers',
        line=dict(color='#3B82F6', width=3),
        marker=dict(size=8)
    ))
    fig_ts.add_trace(go.Scatter(
        x=monthly_ts['Tarih'], y=monthly_ts['Rakip SatÄ±ÅŸ'],
        name='Rakip SatÄ±ÅŸ', mode='lines+markers',
        line=dict(color='#EF4444', width=3),
        marker=dict(size=8)
    ))
    fig_ts.update_layout(height=400, hovermode='x unified')
    st.plotly_chart(fig_ts, use_container_width=True)

with col_ts2:
    st.markdown("#### ðŸ“Š Pazar PayÄ± Trendi")
    fig_share = go.Figure()
    fig_share.add_trace(go.Scatter(
        x=monthly_ts['Tarih'], y=monthly_ts['Pazar PayÄ± %'],
        fill='tozeroy', line=dict(color='#10B981', width=2),
        marker=dict(size=8)
    ))
    fig_share.update_layout(height=400, yaxis=dict(title='Pazar PayÄ± %'))
    st.plotly_chart(fig_share, use_container_width=True)

# Son 3 ay vs Ã¶nceki 3 ay karÅŸÄ±laÅŸtÄ±rma
st.markdown("#### ðŸ“Š Son 3 Ay vs Ã–nceki 3 Ay KarÅŸÄ±laÅŸtÄ±rmasÄ±")

latest_3_months = raw_df[raw_df['DATE'] >= (max_date - pd.DateOffset(months=3))]
previous_3_months = raw_df[(raw_df['DATE'] >= (max_date - pd.DateOffset(months=6))) & 
                           (raw_df['DATE'] < (max_date - pd.DateOffset(months=3)))]

if selected_product == "TROCMETAM":
    pf_col = "TROCMETAM"
elif selected_product == "CORTIPOL":
    pf_col = "CORTIPOL"
elif selected_product == "DEKSAMETAZON":
    pf_col = "DEKSAMETAZON"
else:
    pf_col = "PF IZOTONIK"

latest_total = latest_3_months[pf_col].sum()
previous_total = previous_3_months[pf_col].sum()
growth = ((latest_total - previous_total) / previous_total * 100) if previous_total > 0 else 0

col_comp1, col_comp2, col_comp3 = st.columns(3)
with col_comp1:
    st.metric("ðŸ“… Son 3 Ay", f"{latest_total:,.0f}")
with col_comp2:
    st.metric("ðŸ“… Ã–nceki 3 Ay", f"{previous_total:,.0f}")
with col_comp3:
    st.metric("ðŸ“ˆ DeÄŸiÅŸim", f"{growth:+.1f}%", delta=f"{growth:+.1f}%")

st.markdown("---")

# BÃ–LGE TABLOSU
st.subheader("ðŸ“Š BÃ¶lge BazlÄ± Performans")
bolge_display = bolge_df[bolge_df["PF SatÄ±ÅŸ"] > 0].copy()
bolge_display["PF SatÄ±ÅŸ"] = bolge_display["PF SatÄ±ÅŸ"].apply(lambda x: f"{x:,.0f}")
bolge_display["Toplam Pazar"] = bolge_display["Toplam Pazar"].apply(lambda x: f"{x:,.0f}")
st.dataframe(bolge_display, use_container_width=True, hide_index=True)

# ÅžEHÄ°R DETAYI
st.subheader("ðŸ™ï¸ Åžehir BazlÄ± Detay")
city_display = city_df.sort_values("PF SatÄ±ÅŸ", ascending=False).head(20).copy()
city_display.index = range(1, len(city_display) + 1)
city_display["PF SatÄ±ÅŸ"] = city_display["PF SatÄ±ÅŸ"].apply(lambda x: f"{x:,.0f}")
city_display["Toplam Pazar"] = city_display["Toplam Pazar"].apply(lambda x: f"{x:,.0f}")
city_display = city_display[["Åžehir", "BÃ¶lge", "PF SatÄ±ÅŸ", "Toplam Pazar", "Pazar PayÄ± %", "MÃ¼dÃ¼r"]]
st.dataframe(city_display, use_container_width=True, hide_index=False)

st.markdown("---")

# GÃ–RSELLEÅžTÄ°RMELER
st.subheader("ðŸ“Š DetaylÄ± Analizler")

col_v1, col_v2 = st.columns(2)

with col_v1:
    st.markdown("#### ðŸ† Top 10 Åžehir")
    top10 = city_df.nlargest(10, "PF SatÄ±ÅŸ")
    fig_bar = px.bar(top10, x="PF SatÄ±ÅŸ", y="Åžehir", orientation='h',
                     color="Pazar PayÄ± %", color_continuous_scale="Blues")
    fig_bar.update_layout(height=400)
    st.plotly_chart(fig_bar, use_container_width=True)

with col_v2:
    st.markdown("#### ðŸŽ¯ BÃ¶lge DaÄŸÄ±lÄ±mÄ±")
    fig_pie = px.pie(bolge_df[bolge_df["PF SatÄ±ÅŸ"] > 0], 
                     values="PF SatÄ±ÅŸ", names="BÃ¶lge",
                     color="BÃ¶lge", color_discrete_map=REGION_COLORS)
    fig_pie.update_layout(height=400)
    st.plotly_chart(fig_pie, use_container_width=True)

# MÃœDÃœR PERFORMANSI
st.markdown("#### ðŸ‘¥ MÃ¼dÃ¼r Performans KarÅŸÄ±laÅŸtÄ±rmasÄ±")
mudur_perf = city_df.groupby("MÃ¼dÃ¼r").agg({
    "PF SatÄ±ÅŸ": "sum",
    "Toplam Pazar": "sum"
}).reset_index()
mudur_perf["Pazar PayÄ± %"] = (mudur_perf["PF SatÄ±ÅŸ"] / mudur_perf["Toplam Pazar"] * 100).round(2)
mudur_perf = mudur_perf.sort_values("PF SatÄ±ÅŸ", ascending=False)

fig_mudur = px.bar(mudur_perf, x="MÃ¼dÃ¼r", y="PF SatÄ±ÅŸ",
                   color="Pazar PayÄ± %", color_continuous_scale="Viridis")
fig_mudur.update_layout(height=400, xaxis=dict(tickangle=-45))
st.plotly_chart(fig_mudur, use_container_width=True)

# AYLARA GÃ–RE BÃœYÃœME ANALÄ°ZÄ°
st.markdown("#### ðŸ“Š Aylar ArasÄ± BÃ¼yÃ¼me Analizi")
monthly_growth = monthly_ts.copy()
monthly_growth['BÃ¼yÃ¼me %'] = monthly_growth['PF SatÄ±ÅŸ'].pct_change() * 100

col_mg1, col_mg2 = st.columns(2)

with col_mg1:
    fig_growth = go.Figure()
    fig_growth.add_trace(go.Bar(
        x=monthly_growth['Tarih'],
        y=monthly_growth['BÃ¼yÃ¼me %'],
        marker_color=['#10B981' if x > 0 else '#EF4444' for x in monthly_growth['BÃ¼yÃ¼me %']]
    ))
    fig_growth.update_layout(
        title="AylÄ±k BÃ¼yÃ¼me OranÄ± (%)",
        height=350,
        yaxis=dict(title='BÃ¼yÃ¼me %')
    )
    st.plotly_chart(fig_growth, use_container_width=True)

with col_mg2:
    # Ortalama 3 aylÄ±k bÃ¼yÃ¼me
    avg_3month = monthly_growth.tail(3)['BÃ¼yÃ¼me %'].mean()
    avg_6month = monthly_growth.tail(6)['BÃ¼yÃ¼me %'].mean()
    avg_all = monthly_growth['BÃ¼yÃ¼me %'].mean()
    
    st.markdown("##### ðŸ“ˆ Ortalama BÃ¼yÃ¼me OranlarÄ±")
    st.metric("Son 3 Ay Ort.", f"{avg_3month:.1f}%")
    st.metric("Son 6 Ay Ort.", f"{avg_6month:.1f}%")
    st.metric("TÃ¼m DÃ¶nem Ort.", f"{avg_all:.1f}%")

# EXPORT
st.markdown("---")
st.subheader("ðŸ“¥ Rapor Ä°ndir")

from io import BytesIO

export_df = city_df.sort_values("PF SatÄ±ÅŸ", ascending=False).copy()
export_df["Tarih AralÄ±ÄŸÄ±"] = f"{start_date.strftime('%Y-%m')} - {end_date.strftime('%Y-%m')}"

output = BytesIO()
with pd.ExcelWriter(output, engine='openpyxl') as writer:
    export_df.to_excel(writer, sheet_name='Åžehir Analizi', index=False)
    bolge_df.to_excel(writer, sheet_name='BÃ¶lge Analizi', index=False)
    monthly_ts.to_excel(writer, sheet_name='AylÄ±k Trend', index=False)
    mudur_perf.to_excel(writer, sheet_name='MÃ¼dÃ¼r Performans', index=False)

st.download_button(
    label=f"ðŸ“Š {selected_product} Raporu Ä°ndir (Excel)",
    data=output.getvalue(),
    file_name=f"{selected_product}_raporu_{datetime.now().strftime('%Y%m%d')}.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
