import streamlit as st
import geopandas as gpd
import pandas as pd
import plotly.graph_objects as go
import json
from shapely.geometry import LineString, MultiLineString
import warnings
import numpy as np

warnings.filterwarnings("ignore")

# =============================================================================
# PAGE CONFIG
# =============================================================================
st.set_page_config(page_title="TÃ¼rkiye SatÄ±ÅŸ HaritasÄ±", layout="wide")
st.title("ğŸ—ºï¸ TÃ¼rkiye â€“ BÃ¶lge & Ä°l BazlÄ± Performans Analizi")

# =============================================================================
# BÃ–LGE RENKLERÄ° (COÄRAFÄ° & MODERN)
# =============================================================================
REGION_COLORS = {
    "MARMARA": "#0EA5E9",
    "BATI ANADOLU": "#14B8A6",
    "EGE": "#FCD34D",
    "Ä°Ã‡ ANADOLU": "#F59E0B",
    "GÃœNEY DOÄU ANADOLU": "#E07A5F",
    "KUZEY ANADOLU": "#059669",
    "KARADENÄ°Z": "#059669",
    "AKDENÄ°Z": "#8B5CF6",
    "DOÄU ANADOLU": "#7C3AED",
    "DÄ°ÄER": "#64748B"
}

# =============================================================================
# ÅEHÄ°R EÅLEÅTÄ°RME (MASTER)
# =============================================================================
FIX_CITY_MAP = {
    "AGRI": "AÄRI",
    "BARTÃ„Â±N": "BARTIN",
    "BINGÃƒÂ¶L": "BÄ°NGÃ–L",
    "DÃƒÂ¼ZCE": "DÃœZCE",
    "ELAZIG": "ELAZIÄ",
    "ESKISEHIR": "ESKÄ°ÅEHÄ°R",
    "GÃƒÂ¼MÃƒÂ¼SHANE": "GÃœMÃœÅHANE",
    "HAKKARI": "HAKKARÄ°",
    "ISTANBUL": "Ä°STANBUL",
    "IZMIR": "Ä°ZMÄ°R",
    "IÃ„\x9fDIR": "IÄDIR",
    "KARABÃƒÂ¼K": "KARABÃœK",
    "KINKKALE": "KIRIKKALE",
    "KIRSEHIR": "KIRÅEHÄ°R",
    "KÃƒÂ¼TAHYA": "KÃœTAHYA",
    "MUGLA": "MUÄLA",
    "MUS": "MUÅ",
    "NEVSEHIR": "NEVÅEHÄ°R",
    "NIGDE": "NÄ°ÄDE",
    "SANLIURFA": "ÅANLIURFA",
    "SIRNAK": "ÅIRNAK",
    "TEKIRDAG": "TEKÄ°RDAÄ",
    "USAK": "UÅAK",
    "ZINGULDAK": "ZONGULDAK",
    "Ãƒ\x87ANAKKALE": "Ã‡ANAKKALE",
    "Ãƒ\x87ANKIRI": "Ã‡ANKIRI",
    "Ãƒ\x87ORUM": "Ã‡ORUM",
    "K. MARAS": "KAHRAMANMARAÅ"
}

# =============================================================================
# NORMALIZATION
# =============================================================================
def normalize_city(name):
    if pd.isna(name):
        return None
    name = str(name).upper().strip()
    tr_map = {"Ä°": "I", "Ä": "G", "Ãœ": "U", "Å": "S", "Ã–": "O", "Ã‡": "C", "Ã‚": "A"}
    for k, v in tr_map.items():
        name = name.replace(k, v)
    return name

# =============================================================================
# DATA LOAD
# =============================================================================
@st.cache_data
def load_excel(file=None):
    if file is not None:
        return pd.read_excel(file)
    return pd.DataFrame(columns=["Åehir", "BÃ¶lge", "Ticaret MÃ¼dÃ¼rÃ¼", "Kutu Adet", "Toplam Adet"])

@st.cache_resource
def load_geo():
    gdf = gpd.read_file("turkey.geojson")
    gdf["raw_name"] = gdf["name"].str.upper()
    gdf["fixed_name"] = gdf["raw_name"].replace(FIX_CITY_MAP)
    gdf["CITY_KEY"] = gdf["fixed_name"].apply(normalize_city)
    return gdf

# =============================================================================
# DATA PREP
# =============================================================================
def prepare_data(df, gdf):
    df = df.copy()
    gdf = gdf.copy()

    df["Åehir_fix"] = df["Åehir"].str.upper().replace(FIX_CITY_MAP)
    df["CITY_KEY"] = df["Åehir_fix"].apply(normalize_city)
    df["BÃ¶lge"] = df["BÃ¶lge"].str.upper()
    df["Ticaret MÃ¼dÃ¼rÃ¼"] = df["Ticaret MÃ¼dÃ¼rÃ¼"].str.upper()
    
    df["PF Kutu"] = pd.to_numeric(df["Kutu Adet"], errors="coerce").fillna(0)
    
    toplam_col = None
    possible_names = ["Toplam Adet", "TOPLAM ADET", "Toplam", "TOPLAM", "Total", "Market Total"]
    for col_name in possible_names:
        if col_name in df.columns:
            toplam_col = col_name
            break
    
    if toplam_col:
        df["Toplam Kutu"] = pd.to_numeric(df[toplam_col], errors="coerce").fillna(0)
    else:
        df["Toplam Kutu"] = df["PF Kutu"] * 3
        st.sidebar.warning("âš ï¸ 'Toplam Adet' kolonu bulunamadÄ±, varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor.")

    pf_toplam_kutu = df["PF Kutu"].sum()
    toplam_kutu = df["Toplam Kutu"].sum()

    merged = gdf.merge(df, on="CITY_KEY", how="left")
    merged["Åehir"] = merged["fixed_name"]
    merged["PF Kutu"] = merged["PF Kutu"].fillna(0)
    merged["Toplam Kutu"] = merged["Toplam Kutu"].fillna(0)
    merged["BÃ¶lge"] = merged["BÃ¶lge"].fillna("DÄ°ÄER")
    merged["Ticaret MÃ¼dÃ¼rÃ¼"] = merged["Ticaret MÃ¼dÃ¼rÃ¼"].fillna("YOK")
    merged["Pazar PayÄ± %"] = (merged["PF Kutu"] / merged["Toplam Kutu"] * 100).round(2)
    merged["Pazar PayÄ± %"] = merged["Pazar PayÄ± %"].replace([float('inf'), -float('inf')], 0).fillna(0)

    bolge_df = (
        merged.groupby("BÃ¶lge", as_index=False)
        .agg({"PF Kutu": "sum", "Toplam Kutu": "sum"})
        .sort_values("PF Kutu", ascending=False)
    )
    bolge_df["Pazar PayÄ± %"] = (bolge_df["PF Kutu"] / bolge_df["Toplam Kutu"] * 100).round(2)
    bolge_df["Pazar PayÄ± %"] = bolge_df["Pazar PayÄ± %"].replace([float('inf'), -float('inf')], 0).fillna(0)

    return merged, bolge_df, pf_toplam_kutu, toplam_kutu

# =============================================================================
# GEOMETRY HELPERS
# =============================================================================
def lines_to_lonlat(geom):
    lons, lats = [], []
    if isinstance(geom, LineString):
        xs, ys = geom.xy
        lons += list(xs) + [None]
        lats += list(ys) + [None]
    elif isinstance(geom, MultiLineString):
        for line in geom.geoms:
            xs, ys = line.xy
            lons += list(xs) + [None]
            lats += list(ys) + [None]
    return lons, lats

def get_region_center(gdf_region):
    centroid = gdf_region.geometry.unary_union.centroid
    return centroid.x, centroid.y

# =============================================================================
# FIGURE
# =============================================================================
def create_figure(gdf, manager, view_mode, filtered_pf_toplam, filtered_toplam_pazar):
    gdf = gdf.copy()
    if manager != "TÃœMÃœ":
        gdf = gdf[gdf["Ticaret MÃ¼dÃ¼rÃ¼"] == manager]

    fig = go.Figure()

    for region in gdf["BÃ¶lge"].unique():
        region_gdf = gdf[gdf["BÃ¶lge"] == region]
        color = REGION_COLORS.get(region, "#CCCCCC")
        
        fig.add_choropleth(
            geojson=json.loads(region_gdf.to_json()),
            locations=region_gdf.index,
            z=[1] * len(region_gdf),
            colorscale=[[0, color], [1, color]],
            marker_line_color="white",
            marker_line_width=1.5,
            showscale=False,
            customdata=list(zip(region_gdf["Åehir"], region_gdf["BÃ¶lge"], region_gdf["PF Kutu"], region_gdf["Pazar PayÄ± %"])),
            hovertemplate="<b>%{customdata[0]}</b><br>BÃ¶lge: %{customdata[1]}<br>PF Kutu: %{customdata[2]:,.0f}<br>Pazar PayÄ±: %{customdata[3]:.1f}%<extra></extra>",
            name=region
        )

    lons, lats = [], []
    for geom in gdf.geometry.boundary:
        lo, la = lines_to_lonlat(geom)
        lons += lo
        lats += la

    fig.add_scattergeo(lon=lons, lat=lats, mode="lines", line=dict(color="rgba(255,255,255,0.8)", width=1), hoverinfo="skip", showlegend=False)

    if view_mode == "BÃ¶lge GÃ¶rÃ¼nÃ¼mÃ¼":
        label_lons, label_lats, label_texts = [], [], []
        for region in gdf["BÃ¶lge"].unique():
            region_gdf = gdf[gdf["BÃ¶lge"] == region]
            total = region_gdf["PF Kutu"].sum()
            if total > 0:
                percent = (total / filtered_pf_toplam * 100) if filtered_pf_toplam > 0 else 0
                region_toplam_pazar = region_gdf["Toplam Kutu"].sum()
                pazar_payi = (total / region_toplam_pazar * 100) if region_toplam_pazar > 0 else 0
                lon, lat = get_region_center(region_gdf)
                label_lons.append(lon)
                label_lats.append(lat)
                label_texts.append(f"<b>{region}</b><br>{total:,.0f} ({percent:.1f}%)<br>Pazar PayÄ±: {pazar_payi:.1f}%")

        fig.add_scattergeo(lon=label_lons, lat=label_lats, mode="text", text=label_texts, textfont=dict(size=10, color="black", family="Arial Black"), hoverinfo="skip", showlegend=False)
    else:
        city_lons, city_lats, city_texts = [], [], []
        for idx, row in gdf.iterrows():
            if row["PF Kutu"] > 0:
                percent = (row["PF Kutu"] / filtered_pf_toplam * 100) if filtered_pf_toplam > 0 else 0
                centroid = row.geometry.centroid
                city_lons.append(centroid.x)
                city_lats.append(centroid.y)
                city_texts.append(f"<b>{row['Åehir']}</b><br>{row['PF Kutu']:,.0f} ({percent:.1f}%)<br>Pazar: {row['Pazar PayÄ± %']:.1f}%")
        
        fig.add_scattergeo(lon=city_lons, lat=city_lats, mode="text", text=city_texts, textfont=dict(size=8, color="black", family="Arial"), hoverinfo="skip", showlegend=False)

    fig.update_layout(
        geo=dict(projection=dict(type="mercator"), center=dict(lat=39, lon=35), lonaxis=dict(range=[25, 45]), lataxis=dict(range=[35, 43]), visible=False, bgcolor="rgba(240,240,240,0.3)"),
        height=750,
        margin=dict(l=0, r=0, t=40, b=0),
        paper_bgcolor="white"
    )
    return fig

# =============================================================================
# YATIRIM STRATEJÄ°SÄ°
# =============================================================================
def calculate_investment_strategy(df):
    df = df.copy()
    df = df[df["PF Kutu"] > 0]
    
    if len(df) == 0:
        return df
    
    try:
        df["Pazar BÃ¼yÃ¼klÃ¼ÄŸÃ¼"] = pd.qcut(df["Toplam Kutu"], q=3, labels=["KÃ¼Ã§Ã¼k", "Orta", "BÃ¼yÃ¼k"], duplicates='drop')
    except:
        df["Pazar BÃ¼yÃ¼klÃ¼ÄŸÃ¼"] = "Orta"
    
    try:
        df["Performans"] = pd.qcut(df["PF Kutu"], q=3, labels=["DÃ¼ÅŸÃ¼k", "Orta", "YÃ¼ksek"], duplicates='drop')
    except:
        df["Performans"] = "Orta"
    
    try:
        df["Pazar PayÄ± Segment"] = pd.qcut(df["Pazar PayÄ± %"], q=3, labels=["DÃ¼ÅŸÃ¼k", "Orta", "YÃ¼ksek"], duplicates='drop')
    except:
        df["Pazar PayÄ± Segment"] = "Orta"
    
    df["BÃ¼yÃ¼me AlanÄ±"] = df["Toplam Kutu"] - df["PF Kutu"]
    try:
        df["BÃ¼yÃ¼me Potansiyeli"] = pd.qcut(df["BÃ¼yÃ¼me AlanÄ±"], q=3, labels=["DÃ¼ÅŸÃ¼k", "Orta", "YÃ¼ksek"], duplicates='drop')
    except:
        df["BÃ¼yÃ¼me Potansiyeli"] = "Orta"
    
    def assign_strategy(row):
        pazar_buyuklugu = str(row["Pazar BÃ¼yÃ¼klÃ¼ÄŸÃ¼"])
        pazar_payi = str(row["Pazar PayÄ± Segment"])
        buyume_potansiyeli = str(row["BÃ¼yÃ¼me Potansiyeli"])
        performans = str(row["Performans"])
        
        if (pazar_buyuklugu in ["BÃ¼yÃ¼k", "Orta"] and pazar_payi == "DÃ¼ÅŸÃ¼k" and buyume_potansiyeli in ["YÃ¼ksek", "Orta"]):
            return "ğŸš€ Agresif"
        elif (pazar_buyuklugu in ["BÃ¼yÃ¼k", "Orta"] and pazar_payi == "Orta" and performans in ["Orta", "YÃ¼ksek"]):
            return "âš¡ HÄ±zlandÄ±rÄ±lmÄ±ÅŸ"
        elif (pazar_buyuklugu == "BÃ¼yÃ¼k" and pazar_payi == "YÃ¼ksek"):
            return "ğŸ›¡ï¸ Koruma"
        elif (pazar_buyuklugu == "KÃ¼Ã§Ã¼k" and buyume_potansiyeli == "YÃ¼ksek" and performans in ["Orta", "YÃ¼ksek"]):
            return "ğŸ’ Potansiyel"
        else:
            return "ğŸ‘ï¸ Ä°zleme"
    
    df["YatÄ±rÄ±m Stratejisi"] = df.apply(assign_strategy, axis=1)
    return df

# =============================================================================
# APP FLOW
# =============================================================================
st.sidebar.header("ğŸ“‚ Excel DosyalarÄ± YÃ¼kle")
uploaded_files = st.sidebar.file_uploader("Excel DosyalarÄ±nÄ± SeÃ§in (Birden fazla seÃ§ebilirsiniz)", ["xlsx", "xls"], accept_multiple_files=True)

df = None
geo = load_geo()

if not uploaded_files:
    st.warning("âš ï¸ LÃ¼tfen sol taraftan bir veya daha fazla Excel dosyasÄ± yÃ¼kleyin!")
    st.info("ğŸ“‹ Excel dosyasÄ± ÅŸu kolonlarÄ± iÃ§ermelidir: **Åehir**, **BÃ¶lge**, **Ticaret MÃ¼dÃ¼rÃ¼**, **Kutu Adet**, **Toplam Adet**")
    st.stop()

if len(uploaded_files) > 1:
    file_names = [f.name for f in uploaded_files]
    selected_file_name = st.sidebar.selectbox("ğŸ“Š Analiz Edilecek DosyayÄ± SeÃ§in", file_names)
    selected_file = next(f for f in uploaded_files if f.name == selected_file_name)
    df = load_excel(selected_file)
    st.sidebar.success(f"âœ… SeÃ§ili: {selected_file_name}")
else:
    df = load_excel(uploaded_files[0])
    st.sidebar.success(f"âœ… YÃ¼klendi: {uploaded_files[0].name}")

merged, bolge_df, pf_toplam_kutu, toplam_kutu = prepare_data(df, geo)

st.sidebar.header("ğŸ” Filtre")
view_mode = st.sidebar.radio("GÃ¶rÃ¼nÃ¼m Modu", ["BÃ¶lge GÃ¶rÃ¼nÃ¼mÃ¼", "Åehir GÃ¶rÃ¼nÃ¼mÃ¼"], index=0)
managers = ["TÃœMÃœ"] + sorted(merged["Ticaret MÃ¼dÃ¼rÃ¼"].unique())
selected_manager = st.sidebar.selectbox("Ticaret MÃ¼dÃ¼rÃ¼", managers)

st.sidebar.markdown("---")
st.sidebar.header("ğŸ” GeliÅŸmiÅŸ Filtreler")
bolge_list = ["TÃœMÃœ"] + sorted([b for b in merged["BÃ¶lge"].unique() if b != "DÄ°ÄER"])
selected_bolge = st.sidebar.selectbox("BÃ¶lge SeÃ§in", bolge_list)
strateji_list = ["TÃ¼mÃ¼", "ğŸš€ Agresif", "âš¡ HÄ±zlandÄ±rÄ±lmÄ±ÅŸ", "ğŸ›¡ï¸ Koruma", "ğŸ’ Potansiyel", "ğŸ‘ï¸ Ä°zleme"]
selected_strateji = st.sidebar.selectbox("YatÄ±rÄ±m Stratejisi", strateji_list)

st.sidebar.header("ğŸ¨ BÃ¶lge Renkleri")
for region, color in REGION_COLORS.items():
    if region in merged["BÃ¶lge"].values:
        st.sidebar.markdown(f"<span style='color:{color}'>â¬¤</span> {region}", unsafe_allow_html=True)

# FÄ°LTRELEME
if selected_manager != "TÃœMÃœ":
    filtered_data = merged[merged["Ticaret MÃ¼dÃ¼rÃ¼"] == selected_manager]
else:
    filtered_data = merged.copy()

if selected_bolge != "TÃœMÃœ":
    filtered_data = filtered_data[filtered_data["BÃ¶lge"] == selected_bolge]

filtered_pf_toplam = filtered_data["PF Kutu"].sum()
filtered_toplam_pazar = filtered_data["Toplam Kutu"].sum()
filtered_aktif_sehir = (filtered_data["PF Kutu"] > 0).sum()

fig = create_figure(filtered_data, selected_manager, view_mode, filtered_pf_toplam, filtered_toplam_pazar)
st.plotly_chart(fig, use_container_width=True)

col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("ğŸ“¦ PF Toplam Kutu", f"{filtered_pf_toplam:,.0f}")
with col2:
    st.metric("ğŸª Toplam Pazar", f"{filtered_toplam_pazar:,.0f}")
with col3:
    genel_pazar_payi = (filtered_pf_toplam / filtered_toplam_pazar * 100) if filtered_toplam_pazar > 0 else 0
    st.metric("ğŸ“Š Genel Pazar PayÄ±", f"%{genel_pazar_payi:.1f}")
with col4:
    st.metric("ğŸ™ï¸ Aktif Åehir", f"{filtered_aktif_sehir}")

display_bolge = (
    filtered_data.groupby("BÃ¶lge", as_index=False)
    .agg({"PF Kutu": "sum", "Toplam Kutu": "sum"})
    .sort_values("PF Kutu", ascending=False)
)
display_bolge["PF Pay %"] = (display_bolge["PF Kutu"] / filtered_pf_toplam * 100).round(2) if filtered_pf_toplam > 0 else 0
display_bolge["Pazar PayÄ± %"] = (display_bolge["PF Kutu"] / display_bolge["Toplam Kutu"] * 100).round(2)
display_bolge["Pazar PayÄ± %"] = display_bolge["Pazar PayÄ± %"].replace([float('inf'), -float('inf')], 0).fillna(0)

st.subheader("ğŸ“Š BÃ¶lge BazlÄ± Performans")
bolge_display = display_bolge[display_bolge["PF Kutu"] > 0].copy()
bolge_display = bolge_display[["BÃ¶lge", "PF Kutu", "Toplam Kutu", "PF Pay %", "Pazar PayÄ± %"]]
bolge_display["PF Kutu Formatli"] = bolge_display["PF Kutu"].apply(lambda x: f"{x:,.0f}")
bolge_display["Toplam Kutu Formatli"] = bolge_display["Toplam Kutu"].apply(lambda x: f"{x:,.0f}")
display_cols = bolge_display[["BÃ¶lge", "PF Kutu Formatli", "Toplam Kutu Formatli", "PF Pay %", "Pazar PayÄ± %"]].copy()
display_cols.columns = ["BÃ¶lge", "PF Kutu", "Toplam Pazar", "PF Pay % (Filtrede)", "Pazar PayÄ± %"]
st.dataframe(display_cols, use_container_width=True, hide_index=True)

investment_df = calculate_investment_strategy(filtered_data)
investment_df_original = investment_df.copy()
if selected_strateji != "TÃ¼mÃ¼" and len(investment_df) > 0:
    investment_df = investment_df[investment_df["YatÄ±rÄ±m Stratejisi"] == selected_strateji]

st.subheader("ğŸ¯ YatÄ±rÄ±m Stratejisi Analizi")
if len(investment_df_original) > 0:
    strategy_counts = investment_df_original["YatÄ±rÄ±m Stratejisi"].value_counts()
    col_a, col_b, col_c, col_d, col_e = st.columns(5)
    
    with col_a:
        st.metric("ğŸš€ Agresif", f"{strategy_counts.get('ğŸš€ Agresif', 0)} ÅŸehir")
    with col_b:
        st.metric("âš¡ HÄ±zlandÄ±rÄ±lmÄ±ÅŸ", f"{strategy_counts.get('âš¡ HÄ±zlandÄ±rÄ±lmÄ±ÅŸ', 0)} ÅŸehir")
    with col_c:
        st.metric("ğŸ›¡ï¸ Koruma", f"{strategy_counts.get('ğŸ›¡ï¸ Koruma', 0)} ÅŸehir")
    with col_d:
        st.metric("ğŸ’ Potansiyel", f"{strategy_counts.get('ğŸ’ Potansiyel', 0)} ÅŸehir")
    with col_e:
        st.metric("ğŸ‘ï¸ Ä°zleme", f"{strategy_counts.get('ğŸ‘ï¸ Ä°zleme', 0)} ÅŸehir")

# Åehir Tablosu (devamÄ± kodun geri kalanÄ±nda...)
st.subheader("ğŸ™ï¸ Åehir BazlÄ± Detay Analiz")
if len(investment_df) > 0:
    city_df = investment_df[["Åehir", "BÃ¶lge", "PF Kutu", "Toplam Kutu", "Pazar PayÄ± %", "YatÄ±rÄ±m Stratejisi", "Pazar BÃ¼yÃ¼klÃ¼ÄŸÃ¼", "Performans", "Pazar PayÄ± Segment", "BÃ¼yÃ¼me Potansiyeli", "Ticaret MÃ¼dÃ¼rÃ¼"]].copy()
else:
    city_df = filtered_data[filtered_data["PF Kutu"] > 0][["Åehir", "BÃ¶lge", "PF Kutu", "Toplam Kutu", "Pazar PayÄ± %", "Ticaret MÃ¼dÃ¼rÃ¼"]].copy()
    city_df["YatÄ±rÄ±m Stratejisi"] = "ğŸ‘ï¸ Ä°zleme"

city_df = city_df.sort_values("PF Kutu", ascending=False).reset_index(drop=True)
city_df["PF Kutu Formatli"] = city_df["PF Kutu"].apply(lambda x: f"{x:,.0f}")
city_df["Toplam Kutu Formatli"] = city_df["Toplam Kutu"].apply(lambda x: f"{x:,.0f}")
city_df["PF Pay % (Filtrede)"] = (city_df["PF Kutu"] / filtered_pf_toplam * 100).round(2) if filtered_pf_toplam > 0 else 0
city_df.index = city_df.index + 1

if len(investment_df) > 0:
    display_city = city_df[["Åehir", "BÃ¶lge", "PF Kutu Formatli", "Toplam Kutu Formatli", "PF Pay % (Filtrede)", "Pazar PayÄ± %", "YatÄ±rÄ±m Stratejisi", "Pazar BÃ¼yÃ¼klÃ¼ÄŸÃ¼", "BÃ¼yÃ¼me Potansiyeli", "Ticaret MÃ¼dÃ¼rÃ¼"]].copy()
    display_city.columns = ["Åehir", "BÃ¶lge", "PF Kutu", "Toplam Pazar", "PF Pay % (Filtre)", "Pazar PayÄ± %", "Strateji", "Pazar", "BÃ¼yÃ¼me", "Ticaret MÃ¼dÃ¼rÃ¼"]
else:
    display_city = city_df[["Åehir", "BÃ¶lge", "PF Kutu Formatli", "Toplam Kutu Formatli", "PF Pay % (Filtrede)", "Pazar PayÄ± %", "YatÄ±rÄ±m Stratejisi", "Ticaret MÃ¼dÃ¼rÃ¼"]].copy()
    display_city.columns = ["Åehir", "BÃ¶lge", "PF Kutu", "Toplam Pazar", "PF Pay % (Filtre)", "Pazar PayÄ± %", "Strateji", "Ticaret MÃ¼dÃ¼rÃ¼"]

st.caption("ğŸ“Š Åehirler **PF Kutu hacmine** gÃ¶re sÄ±ralanmÄ±ÅŸtÄ±r")
st.dataframe(display_city, use_container_width=True, hide_index=False)

# =============================================================================
# GÃ–RSELLEÅTÄ°RMELER - YENÄ°LENMÄ°Å (TEKRARSIZ + YENÄ° ANALÄ°ZLER)
# =============================================================================
import plotly.express as px

st.markdown("---")
st.subheader("ğŸ“Š GÃ¶rsel Analizler & Tahminler")

if len(investment_df_original) > 0:
    
    # 1. PARETO ANALÄ°ZÄ° (80/20 KuralÄ±)
    st.markdown("#### ğŸ“ˆ Pareto Analizi - 80/20 KuralÄ±")
    st.caption("ğŸ’¡ Hangi ÅŸehirler toplam satÄ±ÅŸÄ±n %80'ini oluÅŸturuyor?")
    
    pareto_df = investment_df_original.sort_values('PF